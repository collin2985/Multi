<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer Game - Server/P2P Hybrid</title>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; }
        canvas { display: block; }
        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 100;
        }
        button {
            margin-right: 10px;
            padding: 10px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #666; cursor: not-allowed; }
        #status {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: scroll;
        }
        #connectionStatus {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
        }
        #connectionStatus.status-connecting {
            background-color: #ff9800;
        }
        #connectionStatus.status-connected {
            background-color: #4CAF50;
        }
        #connectionStatus.status-disconnected {
            background-color: #f44336;
        }
        #peerInfo {
            position: absolute;
            top: 50px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="controls">
        <button id="joinChunkBtn">Join Chunk</button>
        <button id="addBoxBtn">Add Box</button>
        <button id="removeBoxBtn">Remove Box</button>
    </div>
    <div id="connectionStatus" class="status-disconnected">Disconnected</div>
    <div id="peerInfo">P2P Connections: 0/0<br>Avatars: 0</div>
    <div id="status"></div>

    <script type="importmap">
        {
          "imports": {
            "three": "https://unpkg.com/three@0.138.0/build/three.module.js",
            "renderer": "./js/renderer.js",
            "networking": "./js/networking.js",
            "game": "./js/game.js",
            "ui": "./js/ui.js",
            "terrain": "./js/terrain.js"
          }
        }
    </script>
    <script type="module">
        import { initializeRenderer } from 'renderer';
        import { initializeNetworking } from 'networking';
        import { initializeGame } from 'game';
        import { initializeUI } from 'ui';

        const clientId = 'client_' + Math.random().toString(36).substr(2, 12);
        const uiElements = {
            statusEl: document.getElementById('status'),
            connectionStatusEl: document.getElementById('connectionStatus'),
            peerInfoEl: document.getElementById('peerInfo'),
            joinBtn: document.getElementById('joinChunkBtn'),
            addBtn: document.getElementById('addBoxBtn'),
            removeBtn: document.getElementById('removeBoxBtn')
        };

        const { scene, camera, renderer, playerObject, box, terrainRenderer } = initializeRenderer();

        // Initialize game first to get handleChunkStateChange
        const { animate, updateChunksAroundPlayer, handleChunkStateChange } = initializeGame(clientId, scene, camera, renderer, playerObject, box, uiElements, sendServerMessage, terrainRenderer, peers, avatars);
        
        // Now, initialize networking with the handleChunkStateChange function from game.js
        const { connectToServer, sendServerMessage, peers, avatars } = initializeNetworking(clientId, uiElements, handleChunkStateChange);
        
        initializeUI(uiElements, sendServerMessage, updateChunksAroundPlayer, clientId);

        connectToServer();
        animate();
    </script>
</body>
</html>