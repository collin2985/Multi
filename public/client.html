<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer Game - Server/P2P Hybrid</title>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; }
        canvas { display: block; }
        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 100;
        }
        button {
            margin-right: 10px;
            padding: 10px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #666; cursor: not-allowed; }
        #status {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: scroll;
        }
        #connectionStatus {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 4px;
            color: white;
            font-family: monospace;
        }
        .status-disconnected { background: red; }
        .status-connected { background: green; }
        .status-retrying { background: orange; }
    </style>
</head>
<body>
    <div class="controls">
        <button id="joinChunkBtn">Join Chunk 0,0</button>
        <button id="addBoxBtn">Add Box</button>
        <button id="removeBoxBtn">Remove Box</button>
    </div>
    <div id="status"></div>
    <div id="connectionStatus" class="status-disconnected">Disconnected</div>
    <div id="peerInfo"></div>

    <script type="module">
        import { initializeRenderer } from './renderer.js';
        import { initializeNetworking } from './networking.js';
        import { initializeGame } from './game.js';
        import { initializeUI } from './ui.js';

        const clientId = 'client_' + Math.random().toString(36).substr(2, 12);
        const uiElements = {
            statusEl: document.getElementById('status'),
            connectionStatusEl: document.getElementById('connectionStatus'),
            peerInfoEl: document.getElementById('peerInfo'),
            joinBtn: document.getElementById('joinChunkBtn'),
            addBtn: document.getElementById('addBoxBtn'),
            removeBtn: document.getElementById('removeBoxBtn')
        };

        const { scene, camera, renderer, playerObject, box, terrainRenderer } = initializeRenderer();

        // 1. Initialize networking first. The handleChunkStateChange function will be set later.
        const networking = initializeNetworking(clientId, uiElements);

        // 2. Initialize the game, passing the necessary functions and objects from networking.
        const { animate, updateChunksAroundPlayer, handleChunkStateChange } = initializeGame(clientId, scene, camera, renderer, playerObject, box, uiElements, networking.sendServerMessage, terrainRenderer, networking.peers, networking.avatars);
        
        // 3. Set the handleChunkStateChange on the networking object.
        networking.setChunkHandler(handleChunkStateChange);
        
        initializeUI(uiElements, networking.sendServerMessage, updateChunksAroundPlayer, clientId);

        networking.connectToServer();
        animate();
    </script>
</body>
</html>