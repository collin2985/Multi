AI P2P COMMUNICATION REVIEW - EXECUTIVE SUMMARY
================================================

CRITICAL ISSUES FOUND: 4 Major Problems

ISSUE #1: NetworkManager Missing AI Reference (Line 509)
- Location: public/game.js, setupDataChannel method
- Problem: Code checks "if (this.aiEnemy)" but NetworkManager has NO aiEnemy property
- Impact: New peers don't receive initial AI position when P2P channel opens
- Evidence: aiEnemy exists on GameState, never passed to NetworkManager
  - Line 1182: networkManager.setAudioManager() set
  - Line 1412: networkManager.setPlayerObject() set  
  - NO: networkManager.setAIEnemy() exists
- Result: Initial AI sync fails, new peers miss position update

ISSUE #2: Dead Players in AI Ownership (Lines 5295-5313)
- Location: public/game.js, updateAIEnemyPosition method
- Problem: playerDistances array includes DEAD players without filtering
- Impact: AI ownership can be assigned to dead players
- Evidence: 
  - Lines 5267-5287: Target selection CORRECTLY filters with "if (!this.isDead)"
  - Lines 5295-5313: Ownership calculation MISSING dead checks
- Scenario: 
  1. Player A dies (this.isDead = true)
  2. Ownership check includes dead Player A in distance calculation
  3. Dead A is at position where they died (closest)
  4. newOwner = A.clientId (DEAD PLAYER)
  5. Handoff broadcast sends A.clientId to other players
  6. AI control goes to inactive/dead player
  7. Results in "undefined" owner when A goes offline

ISSUE #3: Timing Race - AI Broadcast Before P2P Ready (Lines 1276 vs 1284)
- Location: public/game.js, initialization order
- Problem: setupAIEnemy() (line 1276) broadcasts before networkManager.connect() (line 1284)
- What happens:
  1. T=0ms: setupAIEnemy() runs
  2. T=10ms: broadcastP2P() called but this.peers is EMPTY
  3. Line 700-713: broadcastP2P checks "if (peer.dataChannel && readyState === 'open')"
  4. Result: Message dropped silently (no open channels yet)
  5. T=500ms: networkManager.connect() called
  6. T=1000ms+: First peer connects and opens dataChannel
  7. But initial spawn broadcast was already lost
- Impact: Late-joining peers never receive initial ai_enemy_spawn message

ISSUE #4: No Empty Array Check (Line 5325)
- Location: public/game.js, line 5325
- Problem: "const newOwner = playerDistances[0].clientId" accessed without checking if array is empty
- Could occur if: All players dead and no fallback
- Impact: Array index out of bounds error

ROOT CAUSE CHAIN:
1. AI broadcast at T=0 (no peers yet) → message lost
2. New peer joins, dataChannel opens
3. setupDataChannel tries to send AI but this.aiEnemy is undefined → silently fails
4. Late peer depends on ai_enemy_update messages (which work)
5. When AI owner dies, playerDistances includes dead owner
6. Dead owner gets AI control (closest position)
7. Dead owner doesn't send updates (inactive)
8. Other peers lose AI control sync
9. "undefined" owner appears in logs

THE FIX STRATEGY:
1. Add filter for dead players in ownership calculation (lines 5295-5313)
2. Add setAIEnemy() method to NetworkManager
3. Call networkManager.setAIEnemy(this.aiEnemy) after setupAIEnemy()
4. Move AI spawn broadcast to setupDataChannel (when P2P ready)
5. Add empty array check before accessing playerDistances[0]

SPECIFIC CODE FIXES:

FIX 1 - Dead Player Filter:
Replace lines 5295-5313 with:
  const playerDistances = [];
  
  if (!this.isDead) {
    playerDistances.push({
      clientId: this.clientId,
      distance: localDist,
      isLocal: true
    });
  }
  
  this.networkManager.avatars.forEach((avatar, peerId) => {
    if (!avatar.userData.isDead) {  // ADD THIS LINE
      const peerDist = Math.sqrt(...);
      playerDistances.push({
        clientId: peerId,
        distance: peerDist,
        isLocal: false
      });
    }
  });

FIX 2 - Add to NetworkManager (around line 365):
  setAIEnemy(aiEnemy) {
    this.aiEnemy = aiEnemy;
  }

FIX 3 - Update initialization (around line 1276):
  Add after this.setupAIEnemy():
    this.networkManager.setAIEnemy(this.aiEnemy);

FIX 4 - Move broadcast to setupDataChannel (line 521):
  Remove broadcastP2P from setupAIEnemy (lines 1504-1511)
  Add to setupDataChannel after player_sync message:
    if (this.gameState && this.gameState.aiEnemy) {
      const aiMessage = {
        type: 'ai_enemy_spawn',
        payload: {
          position: this.gameState.aiEnemy.position.toArray(),
          moving: this.gameState.aiEnemyMoving
        }
      };
      dataChannel.send(JSON.stringify(aiMessage));
    }

FIX 5 - Empty array check (after line 5322):
  if (playerDistances.length === 0) {
    console.warn('No active players for AI ownership');
    return;
  }

VERIFICATION:
- Check console: No "undefined" in ai_control_handoff messages
- Test: New peer joins - AI appears within 2 seconds
- Test: Player dies - AI ownership goes to living player
- Test: All players check - no dead players in ownership list
- Test: Dead player - should NOT appear in new ownership calculations
